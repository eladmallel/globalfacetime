<html>
<head>
	<script src='/static/js/TB.min.js'></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
	<h1>hello there</h1>
	<div id="myPublisherDiv"></div>
	<div id="mySubscriberDiv"></div>
        <script type="text/javascript">
          // Initialize API key, session, and token...
          // Think of a session as a room, and a token as the key to get in to the room
          // Sessions and tokens are generated on your server and passed down to the client
          var apiKey = "41805792";

          $.ajax({
          	method: "GET",
          	url: "/connect",
          	dataType: "json",
          	success: function(data) {
          		console.log("Got data from server: ");
          		console.log(data);

          		var session = TB.initSession(data.sessionId);
          		console.log("session");
          		console.log(session);

				function connectToStreams(streams) {
					for (var i = 0; i < streams.length; i++) {
						var stream = streams[i];
						if (stream.connection.connectionId != session.connection.connectionId) {
							session.subscribe(stream, "mySubscriberDiv");							
						}
					}
				}

				function sessionConnectedHandler(event) {
					console.log("in sessionConnectedHandler");

          			var publisher = TB.initPublisher(apiKey, 'myPublisherDiv');
          			session.publish(publisher);

          			console.log("published");

          			connectToStreams(event.streams);
          		}

          		function streamCreatedHandler(event) {
          			connectToStreams(event.streams);
          		}

          		session.addEventListener('sessionConnected', sessionConnectedHandler);
          		session.addEventListener('streamCreated', streamCreatedHandler);
          		session.connect(apiKey, data.token);

          		console.log("connecting");          		
          	},
          	error: function(error) {

          	} 
          });          
          
        </script>
</body>
</html>